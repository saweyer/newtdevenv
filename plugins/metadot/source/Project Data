// MetaDot.pkg// Copyright 1997-98. S. Weyer. All Rights Reserved Worldwideconstant kAutoCnst 		:= "MetaDot";constant kVersionNum 	:= "3.4";constant kBetaVersion	:= "";constant kDemoVersion	:= NIL;constant kSlotSymbol 	:= 'protos;constant kConstantSymbol:= 'MetaDot;constant kPartDataSymbol:= NIL;constant kNewtSymbol 	:= '|NewtDevEnv:TKnollSys|;constant kProtoDict		:= '|protErr1:TKnollSys|;constant kProtoDict2	:= '|protNOS2:TKnollSys|;DefineGlobalConstant('kMyPopup, func(para, replaceOptions, x1, y1)begin	para.replaceOptions := replaceOptions;	if x1	then para.lastX := x1	else x1 := para.lastX;	if y1	then para.lastY := y1	else y1 := para.lastY;	if HasVariable(para, 'newtPopup)	then para:newtPopup(replaceOptions, x1, y1)	else if kBuild20 or HasVariable(para,'PopupMenu)	then begin		local pp := para:PopupMenu(replaceOptions, {left: x1, top: y1});		pp.pickMaxWidth := GetAppParams().appAreaWidth-10;		pp:?SyncView();		end	else DoPopup(replaceOptions, x1, y1, para);	NIL;	// return this (for value of kPickMeta, i.e., no immed replace)end);constant kFakeStr := "\u00A0";constant kBS := "\u0008";DefineGlobalConstant('kPopupMeta, func(para, x1, y1)begin	// assumes caret already set (via delay) or keyboard	local text := para.text, ch := nil, val;	local INT slen := StrLen(text), first := 0, last := 0;	// find "word" clicked on	if kBuild20 or HasVariable(para,'PointToWord)	then begin		if x1		then begin			if val := para:PointToWord(x1, y1)			then begin				first := val.startChar;						if isAlphaNumeric(ch := text[first]) or ch = $?				then begin					last := val.endChar;					// GetCaretBox not accurate w/o longer delay?					para.charCaret := para:PointToCharOffset(x1,y1);					end;				// otherwise skip (below)				end;			end		else begin // via keyboard?			val := GetCaretBox();			first := last := para.charCaret := val.offset;			x1 := val.left;			y1 := val.top;			end;		end	else begin		//first := last := GetCaretBox().offset; 	// no offset on 1.x		val := para:setEdit(true);					// prevent update initially		PostKeyString(para,kFakeStr);		first := StrPos(text,kFakeStr,0);		PostKeyString(para, kBS);	//backspace		para:setEdit(val);		//ClearUndoStacks();	// delayed? (interfered w/ later AddUndo)		if first		then last := para.charCaret := first		else return NIL;			// shouldn't occur...		//text := para.text;		end;	if not ch	then begin // search L/R from single position		while (first > 0) and (isAlphaNumeric(ch := text[first-1]) or ch = $?)		do first := first-1;		while (last < slen) and (isAlphaNumeric(ch := text[last]) or ch = $?)		do last := last+1;//Print([first,last]);		end;//Print(se);	if first < last and last < slen	then begin		local str := SubStr(text, first, last - first), pos;		local replaceOptions, replaceStuff, lineBegin;		local lineEnd := if kBuild20 then CharPos(text, unicodeCR, last) else StrPos(text, "\n", last);//Print(str);		if (ch := text[last]) = $:		// slot?		then begin 			if replaceOptions := SlotMeta.(Intern(str))			then begin				pos := if kBuild20 then CharPos(text, $,, last) else StrPos(text, ",", last); 				pos :=	// end of val/line					if pos					then if lineEnd						then min(pos,lineEnd)						else pos					else lineEnd;				last := last+1;				if ClassOf(replaceOptions) = 'flags				then begin					local flagVal := 0, bval;					if pos <> lineEnd and	// end with ,						StrFilled(val := TrimString(Substr(text,last,pos-last)))						// and $0 <= (ch := val[0]) and ch <= $9					then try begin						//local newt := GetRoot().(kNewtSymbol);						//if newt						//then val := newt:fixSource(val);	// constants, e.g., protoApp						flagVal := call Compile(val) with ();						if isFrame(flagVal) and replaceOptions = SlotMeta.viewFont						then flagVal :=							if kBuild20							then MakeCompactFont(GetfontFamilyNum(flagVal),									GetFontSize(flagVal), GetFontFace(flagVal))							else if pos := SetContains('[espy,newYork,geneva], flagVal.family)							then (pos << tsFamilyShift) +		  						 (flagVal.face   << tsFaceshift) +		  						 (flagVal.size   << tsSizeShift);						if not isInstance(flagVal, 'int) then flagVal := 0;						end						onexception |evt.ex| do nil;					para.flagVal := flagVal;//Print(flagVal);					replaceOptions := Clone(replaceOptions);					local mask, lastMask := 0;					// first mark 0-defaults and num:					for pos := 0 to Length(replaceOptions)-1					do if  isFrame(val := replaceOptions[pos]) and							(mask := val.mask) and mask <> lastMask and							(((bval := Band(flagVal, mask)) = 0 and val.value = 0) or val.shift)						then begin							lastMask := mask;							replaceOptions[pos] := val := Clone(val);							if val.shift	// pen, round, inset, shadow, round							then begin								bval := (val.menuVal := bval) >> val.shift;								val.item := val.item && (bval + val.offset);								if bval > 0								then val.mark := kCheckMarkChar;								end							else val.mark := kCheckMarkChar;							end;//Print("after mark0");					lastMask := nil;					// next mark non-0 vals (most specific combos last?)					for pos := Length(replaceOptions)-1 to 0 by -1					do  if isFrame(val := replaceOptions[pos]) and // not separator							isInstance(bval := val.value, 'int) and							bval <> 0 and							Band(flagVal, bval) = bval and							(not val.combo or not lastMask)						then begin							replaceOptions[pos] := val := Clone(val);							val.mark := kCheckMarkChar;							if val.combo	// viewEffect?							then lastMask := true							else if (flagVal := Band(flagVal, Bnot(bval))) = 0							then break;							end;//Print("after mark1");					end;				replaceStuff := [str, last, lineEnd, $ , ",\n"];				end;			end		else if ch = $(		// method or function		then begin			local az, meth := first > 0 and				((ch := text[first-1]) = $: or ch = $?);	// !!!c. :?foo(			local names := if meth then MethNames else FuncNames;			if StrEqual(str, "?") // replace from menu			then begin				replaceOptions := call kAZlist with (names, if meth then $:, nil);				replaceStuff := [str, first, last, nil, $(];				end			else begin	// display params for existing fn/meth				az := call kAZindex with (str);				pos := if kBuild20						then  LSearch(names[az],str,0,'|str=|,nil)						else ArrayPos(names[az],str,0,Functions.StrEqual);				if pos				then begin					replaceOptions := (if meth then MethMeta else FuncMeta)[az][pos];					pos := if kBuild20 then CharPos(text, $), last) else StrPos(text, ")", last);						pos :=	// end of expr/line						if pos						then if lineEnd							then min(pos,lineEnd)							else pos						else lineEnd;					replaceStuff := [str, last+1, pos, nil, if pos=lineEnd then ");\n" else $)];					end				end			end		else if ch = $,		then begin	// arg (like protoApp?)			if replaceOptions := ProtMeta.(para.lastProto := Intern(str))			then begin				// look for earlier line break. remember any indent				lineBegin := pos := first;				while (pos := pos-1) >= 0				do if (ch := text[pos]) = unicodeCR					then break					else if not isWhiteSpace(ch)					then lineBegin := pos;				replaceOptions := call kMerge with (replaceOptions); // create sorted list				replaceStuff := [					str,					last+1,					lineEnd,					if pos >= 0 then SubStr(text,pos,lineBegin-pos) else unicodeCR & Substr(text,0,lineBegin),					",\n"];				end			end;		if replaceOptions		then begin//Print(replaceStuff); Print(replaceOptions);			para.replaceStuff := replaceStuff;			if not isArray(replaceOptions)			then replaceOptions := [replaceOptions];			val := para:GlobalBox();			para.flagOffset := para.flagMask := NIL;			call kMyPopup with (para, replaceOptions, x1 - val.left, y1 - val.top);			end;		end;	NIL;	// for viewGestureScriptend);DefineGlobalConstant('kNumberHexStr,  func(INT num) // return a 0x hexadecimal string for a numberbegin//	local num := MakeCompactFont(GetFontFamilyNum(font),GetFontSize(font),GetFontFace(font));	local h := "0123456789ABCDEF", s := Clone("0x12345678");	local INT i, mask := 0x3;	for i := 28 to 0 by -4	do begin		s[9 - i/4] := h[Band(num >> i, mask)];		mask := 0xF;		end;	s;end);DefineGlobalConstant('kIsBounds, func(val)isFrame(val) and Length(val)=4 and val.left);DefineGlobalConstant('kPickMeta, func(para, INT i)begin//Print("pick:" && i);	local ARRAY replaceStuff := para.replaceStuff, args := [replaceStuff[0]];	local ARRAY replaceOptions := para.replaceOptions;	local val := replaceOptions[i], str, first, last;	if isFrame(val)	then begin		args := [val.item];		if val.args		then AddArraySlot(args, val.args);		str := val.value;		if ClassOf(replaceOptions) = 'protMeta		then if isArray(str)		then replaceStuff[3] := replaceStuff[3] & val.item & $: & $ ;		else begin			local sym := para.lastProto, newt := GetRoot().(kNewtSymbol), proto, pval, vj;			if  not ( 					str and	// value: nil, e.g., noScroll?					// "immediate" (vs. "inherited")					(if kBuild20					then LSearch (ProtMeta.(sym), val, 1, '|=|, nil)					else ArrayPos(ProtMeta.(sym), val, 1, nil)					)) and				// a proto exists?				(isFrame(proto := newt.(kProtoDict).(sym)) or			 	 isFrame(proto := newt.(kProtoDict2).(sym))) and				// has non-nil value or slot (w/ nil)				((pval := proto.(sym := Intern(val.item))) or				HasVariable(proto, sym)) and				// value is "printable"?				(isImmediate(pval) or 				(if kBuild20				then isNumber(pval) or isString(pval) or isSymbol(pval)				else isInstance(pval, 'int) or isInstance(pval, 'real) or					 isInstance(pval, 'string) or isInstance(pval, 'symbol)) or				isArray(pval) or call kIsBounds with (pval)					/*isFrame(pval) and Length(pval)=4 and pval.left)					not (if kBuild20 then IsFunction(pval)						else isInstance(pval,' _function) or isInstance(pval, 'CodeBlock))					and not pval.samples and not pval.bits and not pval.family					)*/				)			then str := 				if call kIsBounds with (pval) // bounds frame?				then if not (vj := proto.viewJustify) or						Band(vj,vjParentFullH) = vjParentFullH or						Band(vj,vjParentFullV) = vjParentFullV or						Band(vj,vjSiblingFullH)= vjSiblingFullH or						Band(vj,vjSiblingFullV)= vjSiblingFullV					then "SetBounds(" &						pval.left  & $, & pval.top & $, &						pval.right & $, & pval.bottom & $)					else "RelBounds(" &						pval.left & $, &						pval.top  & $, &						(pval.right-pval.left) & $, &						(pval.bottom-pval.top) & $)				else newt:PrintObject(pval,Clone(""),0,true,"","");			str := "^0:" && if str then str else kNil;	// for slot/meth			end;//Print(str);		if isArray(str)	// another menu		then begin			if ClassOf(str) = 'flags			then begin				first :=					(val.menuVal >> (para.flagShift := val.shift)) +					(para.flagOffset := val.offset);				para.flagMask := val.mask;				if val.length				then begin // shorten contiguous menu					str := ArrayMunger([flags: ],0,0, str,0,val.length-1);					first := first-1; // index					end				else if kBuild20	// e.g., viewFont.size				then first := LSearch(str,first,0,'|=|,'value)				else begin					val := first; first := nil;					for last := 0 to Length(str)-1					do if str[last].value = val						then break first := last;					end;				if first and first >= 0 and first < Length(str)				then begin					if IsReadonly(str)					then str := Clone(str);					val := str[first] := Clone(str[first]);					val.mark := kCheckMarkChar;					end;				end;			return call kMyPopup with (para, str, nil, nil);			end;		end	else str := val;	if (if kBuild20 then IsString(str) else isInstance(str, 'string))	then begin		str := ParamStr(str, args);		// eliminate comment?		if (first := StrPos(str,"/*",0)) and (last := StrPos(str, "*/", first+2))		then StrMunger(str,first,last+2-first, nil,0,nil);		//if BeginsWith(str, "¥")		//then StrMunger(str,0,1, nil,0,nil);	// REQUIRED slot		end	else if ClassOf(replaceOptions) = 'flags // and isInstance(str, 'int)	then begin		if para.flagOffset		then str := (str - para.flagOffset) << para.flagShift;		local mask := para.flagMask;		if not mask and not (mask := val.mask)		then mask := str;		local INT oldVal := Band(para.flagVal, mask);		// save		val := Band(para.flagVal, Bnot(mask));				// turn off		str := if str <> 0 and str <> oldVal			then Bor(val, str)			// turn on			else val;		str := call kNumberHexStr with(str);		end;	str := replaceStuff[3] & str & replaceStuff[4];	first := replaceStuff[1];	last  := replaceStuff[2];	para.replaceStuff := para.replaceOptions := NIL;	StrMunger(Clone(para.text), first, if last then last+1-first, str, 0, nil);	// returns new text (or NIL if no change)end);DefineGlobalConstant('kFixVerStr, func(lab, ARRAY defs, ARRAY meta, ARRAY names)begin	local slot, val;	local INT i, num := 0, az;	for i:=0 to Length(defs)-1 by 2	do begin		slot := defs[i];		val  := defs[i+1];		if kBuild20 and BeginsWith(val, "/*2.x*/")	// leave in 2.1, :PF ?		then StrMunger(val,0,StrPos(val,"*/",4)+2, nil,0,nil);		if kBuild20 or (kBuild1x and not BeginsWith(val, "/*2."))		then begin			az := call kAZindex with (slot);			AddArraySlot(names[az], slot);			AddArraySlot(meta[az],  val);			num := num+1;			end;		end;	if kBuild20	then Print(lab & $: && num)	else Print(lab & $: && num && "(out of" && Length(defs)/2 && "possible)");end);DefineGlobalConstant('kMakeAZStruct, func(cl)	// [/*A*/ [], ]begin	local fr := Array(kLastLetter+1, NIL), i, a;	for i := 0 to kLastLetter	do begin		fr[i] := a := Array(0,nil);		if cl		then SetClass(a, cl);		end;	fr;end);DefineGlobalConstant('kFuncMeta,  call kMakeAZStruct with (nil));	//[["args",...],]DefineGlobalConstant('kFuncNames, call kMakeAZStruct with (nil));	//[["Abs",...],]call kFixVerStr with ("functions", kFuncDefs, kFuncMeta, kFuncNames);DefineGlobalConstant('kMethMeta,  call kMakeAZStruct with (nil));	//[["args",...]]DefineGlobalConstant('kMethNames, call kMakeAZStruct with (nil));	//[...["close",]]call kFixVerStr with ("methods", kMethDefs, kMethMeta, kMethNames);Print("viewMeta:" && Length(kViewMeta));Print("slotMeta:" && Length(kSlotMeta));Print("protMeta:" && Length(kProtMeta));DefineGlobalConstant('kFixNewt, func()begin	local val := GetRoot().(kNewtSymbol).(kConstantSymbol);	if IsReadonly(val)	then GetRoot().(kNewtSymbol).(kConstantSymbol) := {_proto: val}	else val;end);// add a function/method. see kFixVerStr (dev time)DefineGlobalConstant('kAddFuncMeth, func(ARRAY strs, ARRAY vals, nameSym, valSym)begin	local MetaDot := call kFixNewt with (), pos, str, val;	local ARRAY names := MetaDot.(nameSym), meta := MetaDot.(valSym), namesaz, metaaz;	local INT az, i;	if isReadonly(names)	then begin		names := MetaDot.(nameSym) := Clone(names);		meta  := MetaDot.(valSym)  := Clone(meta);		end;	for i:=0 to Length(strs)-1	do begin		val := vals[i];		az := call kAZindex with (str := strs[i]);//Print(str); Print(val); Print(az);		if isReadOnly(namesaz := names[az])		then begin			namesaz := names[az] := Clone(namesaz);			metaaz  := meta[az]  := Clone(meta[az]);			end		else metaaz := meta[az];//Print(namesaz); Print(metaaz);		if kBuild20		then begin			pos := BInsert(namesaz, str, '|str<|, nil, true);			if pos			then ArrayInsert(metaaz, val, pos)	// insert			else if pos := LSearch(namesaz, str, 0, '|str=|, nil)			then metaaz[pos] := val;	// replace			end		else if pos := ArrayPos(namesaz, str, 0, Functions.StrEqual)		then metaaz[pos] := val	// replace		else begin			AddArraySlot(namesaz, str);			Sort(namesaz, '|str<|, nil);			pos := ArrayPos(namesaz, str, 0, Functions.StrEqual);			ArrayMunger(metaaz,pos,0, [val],0,1);			end;		end;end);// add a new proto/slot (not patch existing)DefineGlobalConstant('kAddProtSlot, func(ARRAY strs, ARRAY vals, nameSym)begin	local MetaDot := call kFixNewt with ();	local fr := MetaDot.(nameSym);	local INT i;	if isReadonly(fr)	then fr := MetaDot.(nameSym) := {_proto: fr};	for i:=0 to Length(strs)-1	do fr.(Intern(strs[i])) := vals[i];end);partData := { // defined in MetaDot	ViewMeta:	kViewMeta,	ProtMeta:	kProtMeta,	ProtAdd:	func(name, val)					call kAddProtSlot with (name, val, 'ProtMeta),	SlotMeta:	kSlotMeta,	SlotAdd:	func(name, val)					call kAddProtSlot with (name, val, 'SlotMeta),	FuncNames:	kFuncNames,	FuncMeta:	kFuncMeta,	FuncAdd:	func(strs, vals)					call kAddFuncMeth with (strs, vals, 'FuncNames, 'FuncMeta),	MethNames:	kMethNames,	MethMeta:	kMethMeta,	MethAdd:	func(strs, vals)					call kAddFuncMeth with (strs, vals, 'MethNames, 'MethMeta),	PopupMeta:	kPopupMeta,	//fn	PickMeta:	kPickMeta,	//fn	delay:		if kBuild20 then 100 else 300, // for caret to appear};/*for links?if call kFindBook with (kHelpISBN,nil)then GetRoot().(kBookReaderSymbol):openBook(kHelpISBN);viewer:TurnToContent('name, name);// any fns in docs that don't exist?call func(fr)begin	local slot,val;	foreach slot,val in fr	do if not StrPos(val,"PF*",0) and not GetGlobalFn(slot) then Print(slot);end with (GetGlobalVar('|NewtDevEnv:TKnollSys|).protos.MetaDot.FuncMeta)	// 2.0	do if not StrEqual(val,"*:PF*") and not Functions.(slot) then Print(slot);end with (GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.FuncMeta) 		// 1.x// what 1.x global fns leftover??call func(fns, fr)begin	local slot,val;	foreach slot,val in fr	do RemoveSlot(fns, slot);	fns :=		foreach slot,val in fns		collect SPrintObject(slot);	Sort(fns,'|str<|,nil);//Print(fns);	foreach slot in fns	do Print(slot & $: && Functions.(Intern(slot)).numArgs);end with (Clone(Functions), GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.FuncMeta) GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.FuncNamesGetroot().|NewtDevEnv:TKnollSys|.MetaDot:FuncAdd(["zzz"], ["foo"])getroot().|newtdevenv:tknollsys|.para// ---// check for viewClasses,protos in Newt w/o defs herecall func(protos, protMeta)begin	local slot,val, except := '[ROM_DefRotateFunc, ROM_coverpageformat,		protoCoverPageFormat, protoAboutText, ROM_rcInkOrText, ];	foreach slot,val in protos	do if not HasSlot(protMeta, slot) and not SetContains(except, slot)	then Print(slot);end with (	GetRoot().|NewtDevEnv:TKnollSys|.|protErr1:TKnollSys|,	//protErr1, protNOS2	GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.ProtMeta);// ---// check for defs here w/o entries in Newtcall func(protos1, protos2, protMeta)begin	local slot,val, except := '[clTextView];	foreach slot,val in protMeta	do if not HasSlot(protos1, slot) and not HasSlot(protos2, slot) and not SetContains(except, slot)	then Print(slot);end with (	GetRoot().|NewtDevEnv:TKnollSys|.|protErr1:TKnollSys|,	GetRoot().|NewtDevEnv:TKnollSys|.|protNOS2:TKnollSys|,	GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.ProtMeta);// ---// check for "empty" protos (replace w/ parent except cl*view)call func(protMeta)begin	local slot,val;	foreach slot,val in protMeta	do if Length(val)=1 and val[0]	then Print(slot);end with (	GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.ProtMeta);// ---// check for duplicate (=) items earlier in hierarchy (e.g., inherited)call func(protMeta)begin	local kLSearchDeep := func(anArray,item,last)	begin	local pos;	while isArray(anArray) and anArray<>last	do if  pos := LSearch (anArray, item, 1, '|=|, nil)					//LSearch (anArray, item.item, 1, '|str=|, 'item)		then return pos		else anArray := anArray[0];	NIL;	end;	local slot,val,par,i,last := protMeta.clView;	foreach slot,val in protMeta	do if isArray(par := val[0])		then for i:=1 to Length(val)-1			 do if call kLSearchDeep with (par, val[i],last)				then Print(slot && val[i].item);end with (	GetGlobals().|NewtDevEnv:TKnollSys|.protos.MetaDot.ProtMeta);call func()begin local i;	for i:=1 to 890 do if call compile("@" & i) with () = newtCheckAllButton then break Print(i);end with ()*/